package com.aura.engine.module.shell;

import java.awt.Color;
import java.awt.Composite;
import java.awt.Graphics2D;

import com.aura.client.AuraClient;
import com.aura.engine.AuraEngine;
import com.aura.engine.AuraScreen;
import com.aura.engine.event.EPEventInputMouse;
import com.aura.engine.inputMap.EPMapCE;
import com.aura.engine.inputMap.mouse.EPMouseMapCM;

public abstract class EMShellDialog extends EMShell {
	private String title;
	private int x, y;
	private int w, h;
	
	private boolean moveable;
	private boolean resizeable;
	
	private int minW = 200;
	private int minH = 100;
	
	public EMShellDialog(AuraClient aura, AuraScreen screen, AuraEngine scene, int keyAction, String title) {
		this(aura, screen, scene, keyAction, title, 0, 0, true, true);
	}
	public EMShellDialog(AuraClient aura, AuraScreen screen, AuraEngine scene, int keyAction, String title, int width, int height, boolean moveable, boolean resizeable) {
		super(aura, screen, scene, keyAction);
		this.title = title;
		
		this.w = width < minW ? minW : width;
		this.h = height < minH ? minH : height;
		
		this.moveable = moveable;
		this.resizeable = resizeable;
		
		this.x = scene.getScreenInfo().frameWidth/2 - getWidth()/2;
		this.y = scene.getScreenInfo().frameHeight/2 - getHeight()/2;
	}
	
	@Override
	public void initialize() {
		attach(createFakeGbc(), getBtPin());		
		attach(createFakeGbc(), getBtClose());		
		initializeForDialog();
	}
	public abstract void initializeForDialog();
	
	@Override
	public int getX() {
		return x;
	}
	@Override
	public int getY() {
		return y;
	}
	@Override
	public int getWidth() {
		return w;
	}
	@Override
	public int getHeight() {
		return h;
	}
	
	@Override
	public int getHeaderYDecal() {
		return 14;
	}
	
	public boolean isMoveable() {
		return moveable;
	}
	public boolean isResizeable() {
		return resizeable;
	}
	
	private boolean onMove;
	private boolean onResize;
	private int xClique, yClique;
	
	@Override
	public void doMousePressed(EPEventInputMouse e, EPMapCE map) {
		super.doMousePressed(e, map);
		if (!isVisible() && !isPinned()) return;
		if (map != null
				&& !isPinned()
				&& map.getId() == EPMouseMapCM.SELECT) {
			
			int currentX = (int) getScene().getCurrentCurseurLocation().x;
			int currentY = (int) getScene().getCurrentCurseurLocation().y;
			
			if (isMoveable() 
					&& currentX > getX() 
					&& currentX < getX() + getWidth()
					&& currentY > getY() 
					&& currentY < getY() + 14) {
				onMove = true;
				xClique = currentX - x;
				yClique = currentY - y;
			} else if (isResizeable()
					&& currentX > getX() + getWidth() - 14
					&& currentX < getX() + getWidth()
					&& currentY > getY() + getHeight() - 14
					&& currentY < getY() + getHeight()) {
				onResize = true;
			}
		}
	}
	
	@Override
	public void doMouseReleased(EPEventInputMouse e, EPMapCE map) {
		super.doMouseReleased(e, map);
		if (!isVisible() && !isPinned()) return;
		if (map != null && map.getId() == EPMouseMapCM.SELECT) {
			onMove = false;
			onResize = false;
		}
	}
	
	@Override
	public void doUpdate() {
		super.doUpdate();
		if (!isVisible() && !isPinned()) return;
		if (onMove && !isPinned()) {
			int newX = (int) getScene().getCurrentCurseurLocation().x - xClique;
			int newY = (int) getScene().getCurrentCurseurLocation().y - yClique;
			
			if (newX > getScene().getScreenInfo().frameWidth - getWidth() - 10)
				x = getScene().getScreenInfo().frameWidth - getWidth() - 10;
			else if (newX < 10) 
				x = 10;
			else 
				x = newX;
			
			if (newY > getScene().getScreenInfo().frameHeight - getHeight() - 10)
				y = getScene().getScreenInfo().frameHeight - getHeight() - 10;
			else if (newY < 10) 
				y = 10;
			else 
				y = newY;
			
		} else if (onResize) {
			int newW = (int) getScene().getCurrentCurseurLocation().x - x;
			int newH = (int) getScene().getCurrentCurseurLocation().y - y;

			newW = newW < minW ? minW : newW;
			if (newW + x > getScene().getScreenInfo().frameWidth - 10) {
				newW = w;
			}
			w = newW;
			
			newH = newH < minH ? minH : newH;
			if (newH + y > getScene().getScreenInfo().frameHeight - 10) {
				newH = h;
			}
			h = newH;
		}
	}
	
	@Override
	public void implDoDraw(Graphics2D g) {
		Composite temp = g.getComposite();
		g.setColor(Color.BLACK);
		
		getScene().setComposite(g, (isPinned() ? .25f : .75f));
		{ // DRAW DU FOND
			g.fillRect(getX(), getY(), getWidth(), getHeight());
		}
		
		getScene().setComposite(g, (isPinned() ? .50f : 1f));
		{ // DRAW DU CADRE
			g.setColor(Color.ORANGE);
			g.drawRect(getX(), getY(), getWidth(), getHeight());
			g.drawRect(getX(), getY(), getWidth(), 14);
			if (title != null)
				g.drawString(title, getX()+3, getY()+12);
			if (isResizeable())
				g.drawLine(
					getX() + getWidth() - 14, 
					getY() + getHeight(), 
					getX() + getWidth(), 
					getY() + getHeight() - 14);
		}
		
		getScene().setComposite(g, temp);
		{ // DRAW DES BOUTONS
			getBtPin().draw(g, 
				getX()+getWidth()-24, 
				getY()+2);
			getBtClose().draw(g, 
				getX()+getWidth()-12, 
				getY()+2);
		}
	}

	private MObject btPin;
	public MObject getBtPin() {
		if (btPin == null) {
			btPin = new MObject(getScene(), "!", 10, 10);
			btPin.setVisible(false);
			btPin.attach(new MObjectAction() {
				@Override
				public void execute() {
					pin(!isPinned());
				}
			});
		}
		return btPin;
	}
	
	private MObject btClose;
	public MObject getBtClose() {
		if (btClose == null) {
			btClose = new MObject(getScene(), "+", 10, 10);
			btClose.setVisible(false);
			btClose.attach(new MObjectAction() {
				@Override
				public void execute() {
					show(false);
				}
			});
		}
		return btClose;
	}
}